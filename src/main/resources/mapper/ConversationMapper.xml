<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zzzlew.zzzimserver.mapper.ConversationMapper">

    <select id="selectListByUserIdAndConversationIdList"
            resultType="com.zzzlew.zzzimserver.pojo.vo.conversation.ConversationVO">
        select * from conversation c where c.user_id = #{userId} and c.id in
        <foreach collection="conversationIdList"
                 item="cId"
                 open="("
                 close=")"
                 separator=",">
            #{cId}
        </foreach>
    </select>

    <update id="updateConversationStatus">
        update conversation
        set latest_msg      = #{content},
            latest_msg_time = #{sendTime},
            status          = 1,
            unread_count    = CASE
                                  WHEN user_id = #{receiverId}
                                      THEN unread_count + 1
                                  ELSE unread_count
                END
        where id = #{conversationId}
    </update>

    <insert id="insertGroupConversation"
            parameterType="com.zzzlew.zzzimserver.pojo.dto.conversation.GroupConversationDTO">
        insert into group_conversation (id, group_name, group_avatar, owner_id)
        values (#{id}, #{groupName}, #{groupAvatar}, #{ownerId})
    </insert>

    <update id="updateGroupMemberCount">
        update group_conversation
        set member_count = member_count + 1
        where id = #{conversationId}
    </update>

    <select id="selectGroupListByUserIdAndConversationId"
            resultType="com.zzzlew.zzzimserver.pojo.vo.conversation.GroupConversationVO">
        select gc.id,
               gc.group_name,
               gc.group_avatar,
               gc.owner_id,
               gm.is_top,
               gm.latest_msg,
               gm.latest_msg_time,
               gm.status
        from group_member gm
                 join group_conversation gc on gc.id = gm.group_id
        where gm.user_id = #{userId}
    </select>

</mapper>